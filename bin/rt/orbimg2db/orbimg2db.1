.TH ORBIMG2DB 1 "$Date: 2006/03/01 06:16:12 $"
.SH NAME
orbimg2db \- save images from an orb to a database
.SH SYNOPSIS
.nf
orbimg2db [-p pfname] [-m match] [-r reject] [-n maxpkts] [-S statefile] 
	[-t] [-f] [-v] [-c] [-s] orb db [start-time [period|end-time]]
.fi
.SH DESCRIPTION
orbimg2db reads images from an orb, saving them to a database. orbimg2db
will ignore all packets that are not of type /EXP/IMG (or alternatively, 
as specified by the \fIdefault_suffix\fP parameter in the parameter file). 

If the -t option is specified, orbimg2db will attempt to make 
a thumbnail image for each incoming image. The thumbnail_command 
parameter specifies how to make the image. This should be an executable 
command on the path followed by any necessary arguments. The input imagename, 
then the output thumbnail filename will be appended onto this string 
and placed as a system call. If the command does not return an exit status
of zero, a complaint will be issued and the database row will not be 
added to the thumbnails table.

If the -f option is specified, orbimg2db will attempt to make a 
precomputed video-frame of each image. Usually this involves conversion 
to a convenient format (such as ppm) and appropriate resizing. 

If the -c option is specified, orbimg2db will periodically clean up 
the image database. The database will be cleaned up once at the 
start of the program. After this, after every image acquisition the 
program will check to see whether a time greater than \fIcleanup_interval_sec\fP 
has elapsed. If so, the \fIcleanup_expressions\fP array of the parameter 
file will be used to guide the clean-up. Each entry of this array gives a table
name as a key, and a Datascope expressions (see dbexpressions(5)) as a value. 
All rows matching the given expressions, together with their corresponding 
external files, will be removed. 

If an old (version 100) image packet comes in, i.e. has no explicit format 
specified, orbimg2db attempts to figure it out via the magic number of the blob (see magic(4)).
orbimg2db should recognize JPG, GIF, PBM, PGM, PPM, TIFF, and PNG automatically. 

.SH OPTIONS
.IP -c
Clean up database according to parameter file.
.IP -f
Automatically make precomputed video frames
.IP "-m match"
Specify regular-expression of source-names to select. If this option
is omitted, source names matching the default_suffix from the parameter
file are selected. 
.IP "-n maxpkts"
Stop after collecting the specified number of packets
.IP "-p pfname"
Specify parameter-file name. Default is orbimg2db
.IP "-r reject"
Specify regular-expression of source-names to reject
.IP -s
Automatically add rows to site table for newly seen sites
.IP "-S statefile"
Specify state-file for orb connection
.IP -t
Automatically make thumbnail images
.IP -v
Verbose output
.SH FILES
.SH ENVIRONMENT
.SH PARAMETER FILE
.nf
default_suffix /EXP/IMG
image_filenames %Y/%j/%{imagename}.%H:%M:%S.%{format}
thumbnail_filenames %Y/%j/thumbnails/%{imagename}.%H:%M:%S.%{format}
thumbnail_size 120x120
thumbnail_command convert -size &{thumbnail_size} +profile \\* -resize &{thumbnail_size}
videoframe_filenames %Y/%j/videoframes/%{imagename}.%H:%M:%S.%{format}
videoframe_size 640x480
videoframe_format ppm
videoframe_command convert -size &{videoframe_size} +profile \\* -resize &{videoframe_size}
cleanup_interval_sec 3600
cleanup_expressions &Arr{
	images		time < now() - 2 * 86400
	thumbnails	time < now() - 2 * 86400
	frames		time < now() - 2 * 86400
}
.fi
.SH EXAMPLE
.ft CW
.in 2c
.nf
% orbimg2db -v -f -t mercali.ucsd.edu roadnetimagesdb
.fi
.in
.ft R
.SH RETURN VALUES
orbimg2db: Removed 0 files and 92238 rows for table 'images' with 92238 errors

This type of error often happens if many rows exist that do not have corresponding
external files. 
.SH LIBRARY
.SH DIAGNOSTICS
.SH "SEE ALSO"
.nf
orbserver(1), orb2db(1), orbmonimg(1)
.fi
.SH "BUGS AND CAVEATS"
In clean-up mode, orbimg2db does not remove empty directories, in case 
they are also expected by other applications. This could probably be handled
by adding a cleanup_directories boolean to the parameter file.

The magic-numbers coded in (see magic(4)) should probably be in the 
parameter file.

If the -s option is used to automatically add site-table rows for new cameras, 
rows should not also be added by hand to the site table while orbimg2db is running.
Sites are added with a time in the site table equal to the time of the first packet 
seen for that station. This addition is in packet order, not chronological order: existing
site-table rows are not edited if a packet comes in with timestamp earlier than the start 
time for an existing site-table row. 

multipart images are currently cached to be rebuilt in memory. This could 
get memory intensive for ill-behaved data streams (missing packet fragments,
many late packets etc.) Building the data 
fragments directly into the end files, the next simplest approach, has the 
questionable design feature that database-user applications would have 
to look out for incomplete images. If the memory caching proves a 
performance problem, disk caching may be necessary. 

.SH AUTHOR
.nf
Kent Lindquist 
Lindquist Consulting
.fi
.\" $Id: orbimg2db.1,v 1.8 2006/03/01 06:16:12 lindquis Exp $

