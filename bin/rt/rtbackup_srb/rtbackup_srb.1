.TH RTBACKUP_SRB 1 "$Date: 2006/09/23 16:04:42 $"
.SH NAME
rtbackup_srb \- back up a Datascope waveform database to a Storage Resource Broker
.SH SYNOPSIS
.nf
rtbackup_srb [-p pfname] [-s wfdisc_subset] [-n days] [-i] [-v] [-e] [-f] database collection
.fi
.SH DESCRIPTION
The rtbackup_srb program archives waveforms from an rt1.0 database, with 
the wfsrb1.0 schema extension, to a Storage Resource Broker (SRB) using SRB 
S-commands. 

At startup, rtbackup_srb finds all wfdisc entries which have not yet been
backed up to the SRB. This is determined by finding all records in wfdisc
which do not have corresponding entries in the wfsrb table. Further subsetting
may occur as specified by the command-line options. For example, the -e 
option excludes waveforms for the current jdate and later, which is highly advisable 
if rtbackup_srb is being run on an active real-time system. 

If there are files to be transferred to the SRB, a connection to the 
SRB will be established based on the contents of the MdasAuth and MdasEnv 
entries in the parameter file. All of the SRB
S-commands should be available either on the Unix execution path, or on the 
path specified by the Spath parameter in the 
rtbackup_srb parameter file (the latter will take precedence over the former).

For each file transferred to the SRB, an entry is made in the wfsrb table 
of the database. The fields of this table are roughly similar to those 
of wfdisc (and wftape, wftar). However, in the case of the SRB, instead of 
the fields dir and dfile to uniquely specify the file storage location, the 
file is identified by Szone, Scoll, and Sobj. The SRB 'collection' 
and 'object' names (Scoll and Sobj, respectively) are roughly analogous 
to directory and filenames (respectively) on a Unix filesystem. 
The collection name under which a waveform is 
stored is constructed from the dir name in the wfdisc, combined with the 
top-level SRB collection for the archive as specified by the \fIcollection\fP
argument on the command line. Default collection names (those without the 
zone specified) are not allowed by rtbackup_srb. The zone name must be 
explicitly prepended to the collection path, e.g. /sdscdlib/home/siosrb.sio 
instead of /home/siosrb.sio. 

In addition to backing up the raw waveform files, copies of the descriptor 
file and any tables specified in the backup_tables section of the parameter 
file are archived to the SRB after any waveforms are archived. These 
files are placed under the top-level collection specified on the command line,
under the subdirecory specified by the \fItables_subdir\fP parameter. This 
parameter may be a plain subdirectory name, or an escape sequence for 
epoch2str(3) which will be filled in according to the current system time
(see the example in the PARAMETER FILE section below). 
Backing up the wfsrb table to the SRB is advisable since it will 
facilitate waveform access through database methods mediated entirely 
by the SRB. 

The replicated_backup_resources table of the parameter file specifies a list of physical
resources to which the top-level collection (the one specified on the 
command line) should be additionally backed up at the end of the run. This backup is done 
with the Sbkupsrb(1) command invoked in recursive mode, for each listed resource. If this 
table is left blank, only the one main backup copy is made. If this table contains
valid entries, additional, replicated copies of the backup files are made. 

The rtbackup_srb program participates in the rtdbclean locking mechanism as 
specified in rtdbclean(1) (i.e. rtbackup_srb locks the file .rtdbclean 
during its run and will exit if it cannot do so).

The orb2db_msg_timeout_sec parameter is passed to orb2db_msg(1) with the 
-t option, specifying the maximum amount of time the orb2db process should 
pause during cleanup.

If failure_email_recipients are specified in the parameter file, rtbackup_srb
will send email to the system operators upon failure. 
.SH OPTIONS
.IP -v
Verbose
.IP -f
Force files to be overwritten even if they already exist in the SRB
.IP -i 
Incremental mode. Skip replication of datafiles to other SRB Resources. 
Also skip backup of parametric database tables. This is useful if a huge 
set of waveforms needs to be transferred to the SRB in incremental steps
(i.e. through multiple runs of rtbackup_srb). The replication of duplicates
and transfer of parametric files can be reserved for the final pass.
.IP -e 
Exclude waveforms for the current jdate and later, as determined by the 
system clock. If -e is specified, this subset is applied in addition to any
subset given with the -s option.
.IP "-n days"
If this option is specified, the wfdisc table is subsetted for records whose lddate is newer
than the specified number of days. Specifically, rtbackup_srb will reject all lddate's that 
are earlier than epoch time of (now() - days * 86400), where now() is the value returned 
by the Datascope expression calculator dbexpressions(5). The days parameter may be a real number
rather than an integer, to specify partial days. After the wfdisc is subsetted, the 
wfsrb table will be subsetted according to the maximum and minimum times in the wfdisc 
in order to keep database view sizes within reasonable bounds. 
.IP "-p pfname"
Specify an alternate parameter-file for rtbackup_srb.
.IP "-s wfdisc_subset" 
Only archive the waveforms matching the specified subsetting expression,
which is applied to the wfdisc table.
.SH FILES
At the time of writing, the SRB Zone authority is located at 
.nf

http://www.npaci.edu/dice/srb/zoneAuthority.html

.fi
.SH ENVIRONMENT
.SH PARAMETER FILE
.nf
Spath /home/rt/SRB3_1_0roadnet/utilities/bin

failure_email_recipients kent@lindquistconsulting.com, jeakins@ucsd.edu

MdasEnv &Literal{
mdasCollectionHome '/home/siosrb.sio'
mdasCollectionName '/home/siosrb.sio'
mdasDomainName     'sio'
srbUser            'siosrb'
srbHost            'mercali.ucsd.edu'
srbPort            '8829'
defaultResource    'orion-sekar-ufs'
}

MdasAuth SOME_PASSWORD

tables_subdir tables/%Y%j_%H.%M

orb2db_msg_timeout_sec 900

backup_tables &Tbl{
	affiliation
	arrival
	assoc
	event
	instrument
	netmag
	origerr
	origin
	sensor
	site
	sitechan
	schanloc
	snetsta
	stamag
	wfdisc
	wfmeas
	wfmgme
	wfsrb
}

replicated_backup_resources &Tbl{
	arch-mercali
}
.fi
.SH EXAMPLE
.in 2c
.ft CW
First make a test database:
.nf

% cat > test_usarray 
#
schema rt1.0:wfsrb1.0
dbpath /opt/antelope/data/db/demo/{demo}
%
% touch test_usarray.lastid
%

.fi

Now run rtbackup_srb, with the -e option as though it were running 
on a real-time system:

.nf

% rtbackup_srb -v -e test_usarray /sdscdlib/home/siosrb.sio/usarray

% cat moo
/opt/antelope/4.6p/bin/rtbackup_srb: Initializing SRB connection:
Using default Port 8829.
Client Release = SRB-3.0.2, API version = F.
Server Release = SRB-3.0.2, API version = F.
Client mcatZone = sdscdlib
Server mcatZone = sdscdlib
/opt/antelope/4.6p/bin/rtbackup_srb: SRB connection Initialized
/opt/antelope/4.6p/bin/rtbackup_srb: Locking .rtdbclean
/opt/antelope/4.6p/bin/rtbackup_srb: Excluding data on and later than today's jdate of 2004304
/opt/antelope/4.6p/bin/rtbackup_srb: Making sub-collection 'wf/knetc/1992/138/210426'
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.CHM.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.CHM.BHZ->SRB:19921382155.15.CHM.BHZ | 0.005 MB | 0.010 MB/s | 0.49 s | 2004.10.29 18:01:22 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.CHM.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.CHM.BHN->SRB:19921382155.15.CHM.BHN | 0.005 MB | 0.023 MB/s | 0.22 s | 2004.10.29 18:01:23 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.CHM.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.CHM.BHE->SRB:19921382155.15.CHM.BHE | 0.005 MB | 0.031 MB/s | 0.16 s | 2004.10.29 18:01:24 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.04.EKS2.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.04.EKS2.BHZ->SRB:19921382155.04.EKS2.BHZ | 0.004 MB | 0.027 MB/s | 0.14 s | 2004.10.29 18:01:25 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.04.EKS2.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.04.EKS2.BHN->SRB:19921382155.04.EKS2.BHN | 0.004 MB | 0.029 MB/s | 0.13 s | 2004.10.29 18:01:26 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.04.EKS2.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.04.EKS2.BHE->SRB:19921382155.04.EKS2.BHE | 0.004 MB | 0.026 MB/s | 0.15 s | 2004.10.29 18:01:27 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.USP.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.USP.BHZ->SRB:19921382155.15.USP.BHZ | 0.005 MB | 0.036 MB/s | 0.14 s | 2004.10.29 18:01:27 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.USP.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.USP.BHN->SRB:19921382155.15.USP.BHN | 0.005 MB | 0.037 MB/s | 0.14 s | 2004.10.29 18:01:28 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.15.USP.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.15.USP.BHE->SRB:19921382155.15.USP.BHE | 0.005 MB | 0.037 MB/s | 0.14 s | 2004.10.29 18:01:29 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.19.TKM.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.19.TKM.BHZ->SRB:19921382155.19.TKM.BHZ | 0.005 MB | 0.035 MB/s | 0.16 s | 2004.10.29 18:01:30 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.19.TKM.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.19.TKM.BHN->SRB:19921382155.19.TKM.BHN | 0.005 MB | 0.038 MB/s | 0.15 s | 2004.10.29 18:01:30 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.19.TKM.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.19.TKM.BHE->SRB:19921382155.19.TKM.BHE | 0.005 MB | 0.037 MB/s | 0.15 s | 2004.10.29 18:01:31 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.14.KBK.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.14.KBK.BHZ->SRB:19921382155.14.KBK.BHZ | 0.005 MB | 0.037 MB/s | 0.13 s | 2004.10.29 18:01:32 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.14.KBK.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.14.KBK.BHN->SRB:19921382155.14.KBK.BHN | 0.005 MB | 0.038 MB/s | 0.13 s | 2004.10.29 18:01:33 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.14.KBK.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.14.KBK.BHE->SRB:19921382155.14.KBK.BHE | 0.005 MB | 0.036 MB/s | 0.14 s | 2004.10.29 18:01:34 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.10.AAK.BHZ to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.10.AAK.BHZ->SRB:19921382155.10.AAK.BHZ | 0.004 MB | 0.029 MB/s | 0.16 s | 2004.10.29 18:01:34 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.10.AAK.BHN to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.10.AAK.BHN->SRB:19921382155.10.AAK.BHN | 0.004 MB | 0.029 MB/s | 0.15 s | 2004.10.29 18:01:35 
/opt/antelope/4.6p/bin/rtbackup_srb: Adding file 19921382155.10.AAK.BHE to /sdscdlib/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
LOCAL:/opt/antelope/data/db/demo/wf/knetc/1992/138/210426/19921382155.10.AAK.BHE->SRB:19921382155.10.AAK.BHE | 0.004 MB | 0.033 MB/s | 0.14 s | 2004.10.29 18:01:36 

%

.fi

Finally let's examine the contents of the SRB: 

.nf

% Sls -r usarray
/home/siosrb.sio/usarray:
  C-/home/siosrb.sio/usarray/wf
/home/siosrb.sio/usarray/wf:
  C-/home/siosrb.sio/usarray/wf/knetc
/home/siosrb.sio/usarray/wf/knetc:
  C-/home/siosrb.sio/usarray/wf/knetc/1992
/home/siosrb.sio/usarray/wf/knetc/1992:
  C-/home/siosrb.sio/usarray/wf/knetc/1992/138
/home/siosrb.sio/usarray/wf/knetc/1992/138:
  C-/home/siosrb.sio/usarray/wf/knetc/1992/138/210426
/home/siosrb.sio/usarray/wf/knetc/1992/138/210426:
  19921382155.04.EKS2.BHE
  19921382155.04.EKS2.BHN
  19921382155.04.EKS2.BHZ
  19921382155.10.AAK.BHE
  19921382155.10.AAK.BHN
  19921382155.10.AAK.BHZ
  19921382155.14.KBK.BHE
  19921382155.14.KBK.BHN
  19921382155.14.KBK.BHZ
  19921382155.15.CHM.BHE
  19921382155.15.CHM.BHN
  19921382155.15.CHM.BHZ
  19921382155.15.USP.BHE
  19921382155.15.USP.BHN
  19921382155.15.USP.BHZ
  19921382155.19.TKM.BHE
  19921382155.19.TKM.BHN
  19921382155.19.TKM.BHZ
% 


.fi

And note the creation of the wfsrb table: 

.nf

% ls
test_usarray          test_usarray.lastid   test_usarray.wfsrb    
% 

.fi

.ft R
.in
.SH RETURN VALUES
.SH LIBRARY
.SH ATTRIBUTES
.SH DIAGNOSTICS
.SH "SEE ALSO"
.nf
rtbackup(1), rtdbclean(1), mk_dmc_seed(1), orb2db_msg
.fi
.SH "BUGS AND CAVEATS"
rtbackup_srb will reproduce the entire wfdisc.dir path as a sub-collection of 
the top-level collection provided on the command line. Albeit probably 
harmless, this may create bulky wftar.Scoll values if the dir values are
specified as absolute paths.

The replica version of database tables is set to the current epoch time in
seconds. This is often longer than the print format of Sls -lv will show completely,
so SgetD(1) must be used to get the correct version numbers for a given file.

This version of rtbackup_srb makes an internal list of all the waveform files that 
need to be saved to the SRB, then releases the orb2db_msg lock and transfers the waveform 
files to the SRB while orb2db_msg is back up and running. This presumes several things. 
First, that in general the waveform files being backed up are completed. Second, that if orb2db
does in fact modify one of them, that the modifications are only additions and, at worst, 
the file in the SRB will be longer than reported in the wfsrb table but still contain all the 
data described in the wfsrb row. Third, this assumes that the number of waveform records 
to be transferred to the SRB is not so large as to make storing an internal list of them 
prohibitive. 
.SH AUTHOR
.nf
Kent Lindquist 
Lindquist Consulting
.fi
.\" $Id: rtbackup_srb.1,v 1.15 2006/09/23 16:04:42 lindquis Exp $
